const els={sidebar:document.getElementById("sidebar"),menuBtn:document.getElementById("menuBtn"),newChatBtn:document.getElementById("newChatBtn"),chatHistory:document.getElementById("chatHistory"),messageContainer:document.getElementById("messageContainer"),chatForm:document.getElementById("chatForm"),promptInput:document.getElementById("prompt"),typingIndicator:document.getElementById("typingIndicator"),suggestions:document.getElementById("suggestions"),chatBody:document.getElementById("chatBody")};let currentChatId=null,chats=JSON.parse(localStorage.getItem("chats")||"[]");const debounce=(e,t)=>{let s;return(...a)=>{clearTimeout(s),s=setTimeout(()=>e(...a),t)}};function init(){renderChatHistory(),setupEventListeners(),chats.length?loadChat(currentChatId=chats[0].id):els.suggestions.style.display="block",highlightCode()}function setupEventListeners(){els.chatForm.addEventListener("submit",handleSubmit);let e=debounce(()=>{els.promptInput.style.height="auto",els.promptInput.style.height=`${els.promptInput.scrollHeight}px`},50);els.promptInput.addEventListener("input",e),els.suggestions.addEventListener("click",t=>{let s=t.target.closest(".suggestion-btn");s&&(els.promptInput.value=s.textContent,els.promptInput.focus(),e())}),els.menuBtn.addEventListener("click",()=>{els.sidebar.classList.toggle("open")}),els.newChatBtn.addEventListener("click",createNewChat),els.chatHistory.addEventListener("click",e=>{let t=e.target.closest(".chat-item");if(!t)return;let s=t.dataset.id;e.target.closest(".delete-chat")?deleteChat(s):loadChat(s)}),document.addEventListener("click",e=>{window.innerWidth<=1024&&!els.sidebar.contains(e.target)&&e.target!==els.menuBtn&&els.sidebar.classList.remove("open")}),0===chats.length&&createDefaultChat()}function createDefaultChat(){chats=[{id:currentChatId=Date.now().toString(),title:"Welcome Chat",messages:[{content:"Hello! I'm your AI assistant. How can I help you today?",isUser:!1,isError:!1}],createdAt:new Date().toISOString()}],saveChats(),renderChatHistory(),renderMessages(chats[0].messages),els.suggestions.style.display="block"}function createNewChat(){currentChatId=Date.now().toString(),chats.unshift({id:currentChatId,title:"New Chat",messages:[],createdAt:new Date().toISOString()}),saveChats(),renderChatHistory(),renderMessages([]),setTimeout(()=>addMessage("Hello! I'm your AI assistant. How can I help you today?",!1),800),window.innerWidth<=1024&&els.sidebar.classList.remove("open"),els.promptInput.value="",els.suggestions.style.display="block"}function loadChat(e){currentChatId=e;let t=chats.find(t=>t.id===e);t&&(renderMessages(t.messages),window.innerWidth<=1024&&els.sidebar.classList.remove("open"))}function saveChats(){localStorage.setItem("chats",JSON.stringify(chats))}function renderChatHistory(){let e=document.createDocumentFragment();chats.forEach(t=>{let s=document.createElement("div");s.className=`chat-item ${t.id===currentChatId?"active":""}`,s.dataset.id=t.id,s.innerHTML=`<i class="fas fa-comment"></i><span>${t.title}</span><button class="delete-chat" title="Delete chat"><i class="fas fa-trash"></i></button>`,e.appendChild(s)}),els.chatHistory.innerHTML="",els.chatHistory.appendChild(e)}function deleteChat(e){chats=chats.filter(t=>t.id!==e),saveChats(),renderChatHistory(),currentChatId===e&&(chats.length?loadChat(chats[0].id):(currentChatId=null,renderMessages([]),els.suggestions.style.display="block"))}function renderMessages(e){let t=document.createDocumentFragment();e.forEach(e=>{t.appendChild(createMessageElement(e.content,e.isUser,e.isError))}),els.messageContainer.innerHTML="",els.messageContainer.appendChild(t),scrollToBottom(),highlightCode()}const escapeHtml=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),formatMessage=e=>e.replace(/```(\w*)\n([\s\S]*?)```/g,(e,t,s)=>`<div class="code-box"><div class="lines"></div><pre><code class="language-${t||"plaintext"}">${escapeHtml(s)}</code></pre></div>`).replace(/`([^`]+)`/g,"<code>$1</code>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2" target="_blank" rel="noopener">$1</a>'),scrollToBottom=()=>{els.chatBody.scrollTop=els.chatBody.scrollHeight},highlightCode=()=>{hljs.highlightAll();let e=document.getElementById("code");if(e){let t=e.innerText.trim().split("\n"),s=document.getElementById("lines");s&&(s.innerHTML=t.map((e,t)=>t+1).join("<br>"))}},simulateTyping=(e,t)=>{e.innerHTML=formatMessage(t),scrollToBottom(),highlightCode()};function createMessageElement(e,t=!1,s=!1){let a=document.createElement("div");a.className=`message-row ${t?"user":"ai"}`;let n=document.createElement("div");n.className="message-row-center";let r=document.createElement("div");r.className=`message-avatar ${t?"user":"ai"}`,r.textContent=t?"You":"AI";let l=document.createElement("div");l.className="message-content";let i=document.createElement("div");return i.className=`message-text ${s?"error-message":""}`,i[s?"textContent":"innerHTML"]=s?e:formatMessage(e),l.appendChild(i),n.appendChild(r),n.appendChild(l),a.appendChild(n),a}function addMessage(e,t=!1,s=!1,a=!0){if(a&&currentChatId){let n=chats.find(e=>e.id===currentChatId);n&&(n.messages.push({content:e,isUser:t,isError:s}),t&&"New Chat"===n.title&&(n.title=e.length>30?e.substring(0,30)+"...":e,renderChatHistory()),saveChats())}let r=createMessageElement(e,t,s);els.messageContainer.appendChild(r),scrollToBottom(),s||t?highlightCode():simulateTyping(r.querySelector(".message-text"),e)}async function handleSubmit(e){e.preventDefault();let t=els.promptInput.value.trim();if(t){currentChatId||createNewChat(),addMessage(t,!0),els.promptInput.value="",els.promptInput.style.height="auto",els.typingIndicator.classList.add("active"),els.suggestions.style.display="none",scrollToBottom();try{let s=await fetch("process.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:`prompt=${encodeURIComponent(t)}`}),a=await s.json();if(els.typingIndicator.classList.remove("active"),a.error)addMessage(a.error,!1,!0);else{let n=t.toLowerCase().includes("code")?`\`\`\`javascript${a.text}\`\`\``:a.text;addMessage(n,!1)}}catch(r){els.typingIndicator.classList.remove("active"),addMessage("Failed to connect to the server. Please check your network.",!1,!0),console.error("Fetch error:",r)}}}init();